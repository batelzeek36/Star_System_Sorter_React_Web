<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Integration Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            border: 2px solid #333;
            padding: 20px;
            margin: 20px 0;
            background: #f5f5f5;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        pre {
            background: white;
            padding: 10px;
            overflow: auto;
            max-height: 400px;
        }
        .log {
            background: #fff;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #2196F3;
        }
    </style>
</head>
<body>
    <h1>üß™ API Integration Test</h1>
    <p>Testing computeHDExtractWithCache() with caching behavior</p>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="testFetch()">1. Fetch HD Data (First Call)</button>
        <button onclick="testFetch()">2. Fetch Again (Should Use Cache)</button>
        <button onclick="clearCache()">3. Clear Cache</button>
        <button onclick="testFetch()">4. Fetch After Clear (Should Hit API)</button>
        <button onclick="checkBundle()">5. Check for API Key in Bundle</button>
    </div>

    <div class="test-section">
        <h2>Console Logs</h2>
        <div id="logs"></div>
    </div>

    <div class="test-section">
        <h2>Results</h2>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>localStorage Contents</h2>
        <button onclick="showLocalStorage()">Show localStorage</button>
        <div id="storage"></div>
    </div>

    <script type="module">
        import { computeHDExtractWithCache } from './src/api/bodygraph-client.ts';

        let callCount = 0;

        window.testFetch = async function() {
            callCount++;
            log(`[Call #${callCount}] Starting fetch...`);
            
            const testRequest = {
                dateISO: '1990-01-15',
                time: '14:30',
                timeZone: 'America/New_York',
            };

            const startTime = performance.now();
            
            try {
                const result = await computeHDExtractWithCache(testRequest);
                const duration = (performance.now() - startTime).toFixed(2);
                
                log(`[Call #${callCount}] ‚úÖ Success in ${duration}ms`, 'success');
                showResult(result, callCount, duration);
                showLocalStorage();
            } catch (error) {
                const duration = (performance.now() - startTime).toFixed(2);
                log(`[Call #${callCount}] ‚ùå Error in ${duration}ms: ${error.message}`, 'error');
                showResult({ error: error.message }, callCount, duration);
            }
        };

        window.clearCache = function() {
            const before = localStorage.length;
            localStorage.clear();
            const after = localStorage.length;
            log(`üóëÔ∏è Cache cleared (removed ${before} items)`, 'success');
            showLocalStorage();
        };

        window.showLocalStorage = function() {
            const storage = document.getElementById('storage');
            const items = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                items.push({ key, value: value.substring(0, 100) + '...' });
            }
            
            if (items.length === 0) {
                storage.innerHTML = '<p>localStorage is empty</p>';
            } else {
                storage.innerHTML = '<pre>' + JSON.stringify(items, null, 2) + '</pre>';
            }
        };

        window.checkBundle = async function() {
            try {
                const response = await fetch('/src/api/bodygraph-client.ts');
                const text = await response.text();
                
                if (text.includes('BODYGRAPH_API_KEY')) {
                    log('‚ùå BODYGRAPH_API_KEY found in source (this is expected in dev mode)', 'error');
                } else {
                    log('‚úÖ BODYGRAPH_API_KEY not found in source', 'success');
                }
                
                // Check if any API key value is visible
                if (text.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/)) {
                    log('‚ùå API key value pattern found in source!', 'error');
                } else {
                    log('‚úÖ No API key values found in source', 'success');
                }
            } catch (error) {
                log(`Error checking bundle: ${error.message}`, 'error');
            }
        };

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        function showResult(data, callNum, duration) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.innerHTML = `
                <h3>Call #${callNum} (${duration}ms)</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        // Initial state
        log('üöÄ Test page loaded');
        showLocalStorage();
    </script>
</body>
</html>
